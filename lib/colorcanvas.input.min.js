(function(){var t,o,e,n,r,i,s,p=function(t,o){return function(){return t.apply(o,arguments)}},c={}.hasOwnProperty,u=function(t,o){function e(){this.constructor=t}for(var n in o)c.call(o,n)&&(t[n]=o[n]);return e.prototype=o.prototype,t.prototype=new e,t.__super__=o.prototype,t},l=[].slice;t=jQuery,s=ColorCanvas.Spine,o=ColorCanvas.Color,n=ColorCanvas.Picker,t.colorcanvas={},t.colorcanvas.replaceInputs=function(){return t("input[type=color]").each(function(){return(new e).replace(this)})},t(function(){return t.colorcanvas.replaceInputs()}),i=function(o){function e(){this.drop=p(this.drop,this),this.drag=p(this.drag,this),this.listen=p(this.listen,this),this.close=p(this.close,this),this.open=p(this.open,this),e.__super__.constructor.apply(this,arguments),this.delegateEvents(this.popupEvents),this.el.delegate("click",".close",this.close),this.el.addClass("popup"),this.el.css({position:"absolute"})}return u(e,o),e.prototype.width=400,e.prototype.popupEvents={mousedown:"listen"},e.prototype.open=function(o){var e,n;return null==o&&(o={left:0,top:0}),e=o.left||o.clientX,n=o.top||o.clientY,e+=25,n-=5,this.el.css({left:e,top:n}),t("body").append(this.el),t("body").mousedown(this.close)},e.prototype.close=function(){return t("body").unbind("mousedown",this.close),this.release(),this.trigger("close")},e.prototype.isOpen=function(){return!!this.el.parent().length},e.prototype.listen=function(o){return o.stopPropagation(),o.target===o.currentTarget?(this.dragPosition={left:o.pageX,top:o.pageY},t(document).mousemove(this.drag),t(document).mouseup(this.drop)):void 0},e.prototype.drag=function(t){var o,e;return o={left:t.pageX-this.dragPosition.left,top:t.pageY-this.dragPosition.top},this.dragPosition={left:t.pageX,top:t.pageY},e=this.el.offset(),e.left+=o.left,e.top+=o.top,this.el.css(e)},e.prototype.drop=function(){return t(document).unbind("mousemove",this.drag),t(document).unbind("mouseup",this.drop)},e}(s.Controller),r=function(e){function r(){this.keydown=p(this.keydown,this);var t=this;r.__super__.constructor.apply(this,arguments),this.color||(this.color=new o),this.picker=new n({color:this.color}),this.picker.bind("change",function(){return t.trigger.apply(t,["change"].concat(l.call(arguments)))}),this.append(this.picker)}return u(r,e),r.prototype.events={"submit form":"close","click [data-type=cancel]":"close"},r.prototype.open=function(){return t(document).keydown(this.keydown),r.__super__.open.apply(this,arguments)},r.prototype.close=function(){return t(document).unbind("keydown",this.keydown),r.__super__.close.apply(this,arguments)},r.prototype.cancel=function(){return this.trigger("change",this.picker.original),this.close()},r.prototype.keydown=function(t){switch(t.which){case 27:return this.cancel()}},r}(i),e=function(e){function n(){n.__super__.constructor.apply(this,arguments),this.input||(this.input=t("<input />")),this.color||(this.color=new o({r:255,g:0,b:0})),this.render()}return u(n,e),n.prototype.className="colorCanvasInput",n.prototype.events={click:"open"},n.prototype.render=function(){return this.el.css({background:this.color.toString()})},n.prototype.replace=function(e){return this.input=t(e),this.color.set(new o(this.input.val())),this.input.hide(),this.input.after(this.el),this.input.get(0).type="text"},n.prototype.open=function(){var t=this;return this.picker&&this.picker.isOpen()?(this.picker.close(),void 0):(this.picker=new r({color:this.color}),this.picker.bind("change",function(o){return t.color=o,t.trigger("change",t.color),t.input.val(t.color.toString()),t.input.change(),t.render()}),this.picker.open(this.el.offset()))},n}(s.Controller),ColorCanvas.Input=e,ColorCanvas.Popup=i,ColorCanvas.PickerPopup=r}).call(this);